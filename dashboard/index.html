<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevOps Metrics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        .header p {
            color: #888;
            font-size: 0.9rem;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(0, 212, 255, 0.2);
        }
        .metric-card h3 {
            font-size: 0.85rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .metric-unit {
            font-size: 0.9rem;
            color: #666;
            margin-left: 5px;
        }
        .metric-trend {
            margin-top: 10px;
            font-size: 0.85rem;
        }
        .trend-up { color: #00ff88; }
        .trend-down { color: #ff4757; }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .chart-card h3 {
            margin-bottom: 20px;
            font-size: 1.1rem;
            color: #fff;
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .table-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow-x: auto;
        }
        .table-card h3 {
            margin-bottom: 20px;
            font-size: 1.1rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        th {
            color: #888;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1px;
        }
        td {
            font-size: 0.9rem;
        }
        .status-success {
            color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        .status-failure {
            color: #ff4757;
            background: rgba(255, 71, 87, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        .error {
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid #ff4757;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            color: #ff4757;
        }
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ DevOps Metrics Dashboard</h1>
        <p id="lastUpdated">Loading metrics...</p>
    </div>

    <div class="metrics-grid" id="doraMetrics">
        <div class="metric-card">
            <h3>Deployment Frequency</h3>
            <div><span class="metric-value" id="depFreq">-</span><span class="metric-unit">/day</span></div>
        </div>
        <div class="metric-card">
            <h3>Lead Time</h3>
            <div><span class="metric-value" id="leadTime">-</span><span class="metric-unit">hours</span></div>
        </div>
        <div class="metric-card">
            <h3>Change Failure Rate</h3>
            <div><span class="metric-value" id="cfr">-</span><span class="metric-unit">%</span></div>
        </div>
        <div class="metric-card">
            <h3>Mean Time to Recovery</h3>
            <div><span class="metric-value" id="mttr">-</span><span class="metric-unit">hours</span></div>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-card">
            <h3>üìà Daily Deployments</h3>
            <div class="chart-container">
                <canvas id="deploymentChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3>üîÑ Pipeline Health</h3>
            <div class="chart-container">
                <canvas id="pipelineChart"></canvas>
            </div>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-card">
            <h3>‚è±Ô∏è PR Cycle Time Distribution</h3>
            <div class="chart-container">
                <canvas id="cycleTimeChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3>üìä Failure Rate Trend</h3>
            <div class="chart-container">
                <canvas id="failureRateChart"></canvas>
            </div>
        </div>
    </div>

    <div class="table-card">
        <h3>üìã Recent Pull Requests</h3>
        <table id="prTable">
            <thead>
                <tr>
                    <th>PR #</th>
                    <th>Title</th>
                    <th>State</th>
                    <th>Cycle Time</th>
                    <th>Author</th>
                </tr>
            </thead>
            <tbody id="prTableBody">
                <tr><td colspan="5" class="loading">Loading...</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        // Chart.js default config
        Chart.defaults.color = '#888';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';

        let deploymentChart, pipelineChart, cycleTimeChart, failureRateChart;

        async function loadCSV(path) {
            try {
                const response = await fetch(path);
                if (!response.ok) throw new Error(`Failed to load ${path}`);
                const text = await response.text();
                return new Promise((resolve) => {
                    Papa.parse(text, {
                        header: true,
                        dynamicTyping: true,
                        complete: (results) => resolve(results.data.filter(row => Object.keys(row).length > 1))
                    });
                });
            } catch (error) {
                console.error(`Error loading ${path}:`, error);
                return [];
            }
        }

        async function loadMetrics() {
            try {
                // Load all CSV files
                const [snapshot, daily, pipeline, prFlow] = await Promise.all([
                    loadCSV('out/metrics_snapshot.csv'),
                    loadCSV('out/dora_daily.csv'),
                    loadCSV('out/pipeline_health.csv'),
                    loadCSV('out/flow_pr.csv')
                ]);

                // Update DORA metrics from snapshot
                if (snapshot.length > 0) {
                    const metrics = snapshot[0];
                    document.getElementById('depFreq').textContent = metrics.deployment_frequency_per_day || '0';
                    document.getElementById('leadTime').textContent = metrics.lead_time_hours_proxy || '0';
                    document.getElementById('cfr').textContent = metrics.change_failure_rate_pct || '0';
                    document.getElementById('mttr').textContent = metrics.mttr_hours || '0';
                }

                // Deployment chart
                if (daily.length > 0) {
                    const labels = daily.map(d => d.day);
                    const successData = daily.map(d => d.prod_success || 0);
                    const failureData = daily.map(d => d.prod_failure || 0);

                    if (deploymentChart) deploymentChart.destroy();
                    deploymentChart = new Chart(document.getElementById('deploymentChart'), {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Success',
                                    data: successData,
                                    backgroundColor: 'rgba(0, 255, 136, 0.7)',
                                    borderRadius: 4
                                },
                                {
                                    label: 'Failure',
                                    data: failureData,
                                    backgroundColor: 'rgba(255, 71, 87, 0.7)',
                                    borderRadius: 4
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: { stacked: true },
                                y: { stacked: true, beginAtZero: true }
                            }
                        }
                    });

                    // Failure rate trend
                    const failureRates = daily.map(d => d.failure_rate_pct || 0);
                    if (failureRateChart) failureRateChart.destroy();
                    failureRateChart = new Chart(document.getElementById('failureRateChart'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Failure Rate %',
                                data: failureRates,
                                borderColor: '#ff4757',
                                backgroundColor: 'rgba(255, 71, 87, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: { y: { beginAtZero: true, max: 100 } }
                        }
                    });
                }

                // Pipeline health chart
                if (pipeline.length > 0) {
                    const buckets = [...new Set(pipeline.map(p => p.bucket))];
                    const conclusions = [...new Set(pipeline.map(p => p.conclusion))];
                    const colors = {
                        success: 'rgba(0, 255, 136, 0.7)',
                        failure: 'rgba(255, 71, 87, 0.7)',
                        cancelled: 'rgba(255, 193, 7, 0.7)',
                        skipped: 'rgba(108, 117, 125, 0.7)'
                    };

                    const datasets = conclusions.map(c => ({
                        label: c,
                        data: buckets.map(b => {
                            const match = pipeline.find(p => p.bucket === b && p.conclusion === c);
                            return match ? match.count : 0;
                        }),
                        backgroundColor: colors[c] || 'rgba(123, 44, 191, 0.7)',
                        borderRadius: 4
                    }));

                    if (pipelineChart) pipelineChart.destroy();
                    pipelineChart = new Chart(document.getElementById('pipelineChart'), {
                        type: 'bar',
                        data: { labels: buckets, datasets },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            indexAxis: 'y',
                            scales: { x: { stacked: true }, y: { stacked: true } }
                        }
                    });
                }

                // PR cycle time chart
                if (prFlow.length > 0) {
                    const cycleTimes = prFlow.filter(p => p.cycle_time_hours).map(p => p.cycle_time_hours);
                    const bins = [0, 1, 4, 8, 24, 48, 168, Infinity];
                    const binLabels = ['<1h', '1-4h', '4-8h', '8-24h', '1-2d', '2-7d', '>7d'];
                    const binCounts = binLabels.map(() => 0);

                    cycleTimes.forEach(ct => {
                        for (let i = 0; i < bins.length - 1; i++) {
                            if (ct >= bins[i] && ct < bins[i + 1]) {
                                binCounts[i]++;
                                break;
                            }
                        }
                    });

                    if (cycleTimeChart) cycleTimeChart.destroy();
                    cycleTimeChart = new Chart(document.getElementById('cycleTimeChart'), {
                        type: 'bar',
                        data: {
                            labels: binLabels,
                            datasets: [{
                                label: 'PRs',
                                data: binCounts,
                                backgroundColor: 'rgba(0, 212, 255, 0.7)',
                                borderRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: { y: { beginAtZero: true } }
                        }
                    });

                    // PR table
                    const tbody = document.getElementById('prTableBody');
                    tbody.innerHTML = prFlow.slice(0, 10).map(pr => `
                        <tr>
                            <td>#${pr.pr_number || '-'}</td>
                            <td>${pr.title || '-'}</td>
                            <td><span class="status-${pr.state === 'merged' ? 'success' : 'failure'}">${pr.state || '-'}</span></td>
                            <td>${pr.cycle_time_hours ? pr.cycle_time_hours.toFixed(1) + 'h' : '-'}</td>
                            <td>${pr.author || '-'}</td>
                        </tr>
                    `).join('');
                }

                document.getElementById('lastUpdated').textContent = `Last updated: ${new Date().toLocaleString()}`;

            } catch (error) {
                console.error('Error loading metrics:', error);
                document.getElementById('lastUpdated').innerHTML = `<span class="error">Error loading metrics: ${error.message}</span>`;
            }
        }

        // Load on page load
        loadMetrics();

        // Auto-refresh every 5 minutes
        setInterval(loadMetrics, 5 * 60 * 1000);
    </script>
</body>
</html>
